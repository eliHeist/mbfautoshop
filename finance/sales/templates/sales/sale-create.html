{% load widget_tweaks %}

<c-layout title="Sale create">
    <c-slot name="scripts">
        <script>
            const saleDATA = {
                parts: [],
                added_parts: [],
                add_mode: false,
                search_text: '',
                loading_state: false,
                loading_message: '',
                sale: {
                    date: new Date().toISOString().split('T')[0],
                    payment_date: new Date().toISOString().split('T')[0],
                    items: [],
                    getSubTotal() {
                        let total = 0
                        this.items.forEach((item) => {
                            total += item.quantity * item.part.selling_price
                        })
                        return total
                    }
                },
                async fetchParts() {
                    const request = await fetch("{% url 'api:get_all_parts' %}")
                    const response = await request.json()
                    this.parts = response
                },
                filteredParts() {
                    parts = this.parts.filter((part) => {
                        return part.name.toLowerCase().includes(this.search_text.toLowerCase()) || part.type.name.toLowerCase().includes(this.search_text.toLowerCase()) || part.part_number.toLowerCase().includes(this.search_text.toLowerCase())
                    })
                    return parts
                },
                addItem(part) {
                    if (this.added_parts.includes(part)) {
                        return
                    }

                    let item = {
                        id: 0,
                        part: part,
                        quantity: 1
                    }

                    this.sale.items.push(item)
                    this.added_parts.push(part)
                },
                removeItem(item) {
                    this.added_parts = this.added_parts.filter((value) => {
                        value != item.part
                    })
                    this.sale.items = this.sale.items.filter((value) => {
                        value != item
                    })
                },
                init() {
                    this.fetchParts()
                },
                handleSubmit() {
                    this.loading_state = true
                    this.loading_message = 'Verifying...'

                    // check if sale has a payment date, sale date, at least 1 item and each item has a quantity
                    if (!this.sale.payment_date || !this.sale.date || this.sale.items.length == 0) {
                        this.loading_state = false
                        return
                    }

                    this.loading_message = 'Verifying items...'

                    // check if each item has a quantity
                    for (let i = 0; i < this.sale.items.length; i++) {
                        if (!this.sale.items[i].quantity || this.sale.items[i].quantity > this.sale.items[i].part.stock_quantity) {
                            alert(`Check item ${this.sale.items[i].part.name}. \nQuantity must be greater than 0 and less than or equal to ${this.sale.items[i].part.stock_quantity}.`)
                            this.loading_state = false
                            return
                        }
                    }

                    this.postSale()
                },
                async postSale() {
                    let url = ``
                }
            }
        </script>
    </c-slot>
    <div class="items-center flex flex-wrap justify-between mb-3">
        <div class="breadcrumbs text-sm">
            <ul>
                <li><a href="{% url 'sales:list' %}">Sales</a></li>
                <li><a>Create a sale</a></li>
            </ul>
        </div>
        <ul class="menu menu-horizontal bg-base-100 rounded-box">
            <!-- <li>
                <a href="{% url 'sales:create' %}">Add a Sale</a>
            </li> -->
        </ul>
    </div>
    <section x-data="saleDATA">
        <div id="loader" x-show="loading_state" class="fixed inset-0 z-50 grid place-content-center bg-base-100/70">
            <span class="loading loading-dots loading-lg"></span>
        </div>
        <div class="relative">
            <div class="items grid z-10 p-4 bg-neutral rounded-t-4xl fixed bottom-0 left-2 right-2 transition-all ease-linear duration-300"
                :class="add_mode ? 'top-16' : 'top-full'">
                <div class="grid pt-4 relative">
                    <ul class="list">
                        <li class="list-row sticky top-0">
                            <input type="text"
                                class="list-col-grow rounded-full px-4 py-2 bg-neutral text-base-200 border-2 border-base-300/50 placeholder:text-base-300/60"
                                placeholder="Search here" x-model="search_text">
                        </li>
                        <template x-for="part in filteredParts()">
                            <li x-show="!added_parts.includes(part)"
                                class="list-row text-base-200 bg-base-content my-1">
                                <div class="list-col-grow">
                                    <div x-text="part.name"></div>
                                    <span x-text="part.type.name" class="font-semibold opacity-60 text-xs"></span>
                                    <div x-text="part.part_number" class="font-semibold opacity-80"></div>
                                    <div x-text="Number(part.selling_price).toLocaleString()"></div>
                                </div>
                                <div>
                                    <button type="button"
                                        class="h-12 w-12 rounded-box grid place-content-center text-success bg-success/10"
                                        @click="addItem(part)">
                                        <span class="">&UpArrow;</span>
                                    </button>
                                </div>
                            </li>
                        </template>
                    </ul>
                    <button type="button"
                        class="h-12 w-12 rounded-box grid place-content-center text-error bg-error/10 absolute bottom-4 left-0"
                        @click="add_mode = false">
                        <span class="rotate-45 scale-150">&plus;</span>
                    </button>
                </div>
            </div>
            <form method="post @container/saleform">
                {% csrf_token %}
                <div class="sale mb-4">
                    <div class="collapse collapse-plus">
                        <input type="checkbox" />
                        <div class="collapse-title text-sm font-semibold">Edit Sale details</div>
                        <div class="collapse-content rounded-box text-sm bg-base-100 border-base-300 border">
                            <fieldset class="fieldset">
                                <legend class="fieldset-legend">Sale date</legend>
                                <input type="date" name="date" class="input" x-model="sale.date"/>
                                <p class="label">When the items left the store</p>
                            </fieldset>
                            <fieldset class="fieldset">
                                <legend class="fieldset-legend">Payment date</legend>
                                <input type="date" name="date" class="input" x-model="sale.payment_date"/>
                                <p class="label">When the payment was made</p>
                            </fieldset>
                        </div>
                    </div>
                </div>

                <div class="grid items">
                    <ul class="list bg-base-100 rounded-box shadow-md">
                        <li class="list-row text-xs opacity-60 mb-2">Parts in Sale
                            <div class="badge badge-xs badge-info badge-outline ml-2" x-text="sale.items.length"></div>
                        </li>
                        <template x-for="item in sale.items">
                            <li class="list-row">
                                <div class="list-col-grow">
                                    <div x-text="item.part.name"></div>
                                    <!-- <span x-text="item.part.type.name" class="font-semibold opacity-60 text-xs"></span> -->
                                    <div x-text="item.part.part_number" class="font-semibold opacity-80"></div>
                                    <div class="flex gap-2">
                                        <button type="button"
                                            class="h-8 w-8 rounded-box grid place-content-center text-error bg-error/10"
                                            @click="removeItem(item)">
                                            <span class="rotate-45 scale-150">&plus;</span>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <div x-text="`x${item.quantity}`"></div>
                                    <div x-text="(item.part.selling_price*item.quantity).toLocaleString()"></div>
                                    <div class="flex flex-row-reverse gap-2">
                                        <button type="button"
                                            class="h-8 w-8 rounded-box grid place-content-center text-neutral bg-neutral/10 disabled:opacity-20 disabled:cursor-not-allowed"
                                            :disabled="item.quantity >= item.part.stock_quantity"
                                            @click="item.quantity++">
                                            <span class="scale-150">&plus;</span>
                                        </button>
                                        <button type="button"
                                            class="h-8 w-8 rounded-box grid place-content-center text-neutral bg-neutral/10 disabled:opacity-20 disabled:cursor-not-allowed"
                                            :disabled="item.quantity <= 1"
                                            @click="item.quantity--">
                                            <span class="scale-150">&minus;</span>
                                        </button>
                                    </div>
                                </div>
                            </li>
                        </template>
                        <li class="p-4 mt-2">
                            <button type="button" class="w-full btn btn-outline btn-neutral" @click="add_mode = true">
                                Add Item
                            </button>
                        </li>
                        <li class="list-row">
                            <div class="list-col-grow">Subtotal</div>
                            <div class="font-semibold" x-text="sale.getSubTotal().toLocaleString()"></div>
                        </li>
                        <li class="list-row p-4 mt-4">
                            <div class="list-col-grow">Total</div>
                            <div class="font-semibold" x-text="sale.getSubTotal().toLocaleString()"></div>
                        </li>
                    </ul>
                </div>

                <div class="form-actions grid mt-4">
                    <button class="btn btn-primary" type="submit">Save</button>
                </div>

            </form>
        </div>
    </section>

    <script>
        new TomSelect("select.tom-select", {
            create: false,
            sortField: {
                field: "text",
                direction: "asc"
            }
        });
    </script>
</c-layout>